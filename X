' Declare sub procedure named ApplyReleaseKinetics
Sub ApplyReleaseKinetics()

  ' Declare variables
  Dim wsMetal As Worksheet  ' Variable to hold the "Metal" worksheet object
  Dim wsGeneral As Worksheet  ' Variable to hold the "General" worksheet object
  Dim lastRow As Long  ' Variable to store the last row with data in the "Metal" sheet
  Dim i As Long  ' Loop counter variable
  Dim initialAmount As Double  ' Variable to store the initial amount from column D
  Dim combinedResult As String  ' Variable to store the combined release kinetics results
  Dim dayPercentages(1 To 5) As Double  ' Array to store kinetic percentages for up to 5 days

  ' Set the worksheets by reference
  Set wsMetal = ThisWorkbook.Sheets("Metal")  ' Assign "Metal" sheet object to wsMetal variable
  Set wsGeneral = ThisWorkbook.Sheets("General")  ' Assign "General" sheet object to wsGeneral variable

  ' Check if cell D9 in General sheet has the expected text
  If wsGeneral.Range("D9").Value <> "Known release kinetics (historical)" Then
    ' Display message box if text is not found
    MsgBox "Known release kinetics (historical) is not set in General!D9", vbExclamation
    ' Exit the sub procedure if text is not found
    Exit Sub
  End If

  ' Get the last row with data in the "Metal" sheet (assuming data starts from D2)
  lastRow = wsMetal.Cells(wsMetal.Rows.Count, "D").End(xlUp).Row  ' Find the last row with data in column D

  ' Loop through each row of data (starting from D2)
  For i = 2 To lastRow  ' Loop from row 2 to the last row with data
    ' Assuming the amount is in column D
    initialAmount = wsMetal.Cells(i, 4).Value  ' Get the value from column D (assuming initial amount is in column 4)

    ' Initialize cumulative percent and combined result
    cumulativePercent = 0  ' Variable to track total release percentage
    combinedResult = ""  ' String to store the combined release kinetics results

    ' Retrieve kinetic data from General sheet (loop to handle up to 5 days)
    For j = 1 To 5  ' Loop from 1 to 5 to retrieve data for up to 5 days
      dayPercentages(j) = wsGeneral.Range("K" & j + 1).Value  ' Get the value from cell K(j+1) (adjust cell reference if needed) and store it in the array
    Next j

    ' Calculate for each day (up to 5 days)
    For j = 1 To 5  ' Loop from 1 to 5 to perform calculations for each day
      ' Check if cumulative percent is less than 1 (to avoid exceeding 100% release)
      If cumulativePercent < 1 Then
        cumulativePercent = cumulativePercent + dayPercentages(j)  ' Add the kinetic percentage for the current day
        ' Add formatted release amount for the current day to the combined result string
        combinedResult = combinedResult & vbCrLf & _  ' Add line break after each day's calculation
          "Day " & j & ": " & Format(initialAmount * dayPercentages(j), "0.00") & " Âµg"
      End If
    Next j

    ' Output the combined result in column L (assuming results go to column L)
    wsMetal.Cells(i, 12).Value = combinedResult  ' Write the combined result string to cell L(i) (adjust column reference if needed)
  Next i

  ' Display message box after processing all rows
  MsgBox "Release kinetics applied and results saved in column L of the 'Metal' sheet.", vbInformation
End Sub
